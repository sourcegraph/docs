/**
 * Reads all .svg files from each subdirectory of src/images/logos/
 * and generates an icons.generated.ts per subdirectory (Iconify-compatible icon set),
 * plus a barrel src/images/logos/index.ts that re-exports all packs.
 *
 * Run: node dev/generate-mermaid-icons.mjs
 */
import fs from 'fs';
import path from 'path';
import {fileURLToPath} from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const logosDir = path.join(__dirname, '..', 'src/images/logos');

function extractBody(raw) {
	return raw
		.replace(/^<\?xml[^?]*\?>\s*/, '')
		.replace(/^<svg[^>]*>/, '')
		.replace(/<\/svg>\s*$/, '')
		.trim();
}

// Discover subdirectories (each is an icon pack)
const packs = fs
	.readdirSync(logosDir, {withFileTypes: true})
	.filter(d => d.isDirectory())
	.map(d => d.name);

if (packs.length === 0) {
	console.log('No icon pack directories found under src/images/logos/');
	process.exit(0);
}

const barrelLines = [
	'// AUTO-GENERATED by dev/generate-mermaid-icons.mjs — do not edit manually'
];

for (const pack of packs) {
	const packDir = path.join(logosDir, pack);
	const files = fs.readdirSync(packDir).filter(f => f.endsWith('.svg'));

	if (files.length === 0) {
		console.log(`Skipping ${pack}/ — no .svg files`);
		continue;
	}

	const icons = {};
	for (const file of files) {
		const name = file.replace('.svg', '');
		const raw = fs.readFileSync(path.join(packDir, file), 'utf-8');
		icons[name] = {body: extractBody(raw), width: 40, height: 40};
	}

	const outFile = path.join(packDir, 'icons.generated.ts');
	const output = `// AUTO-GENERATED by dev/generate-mermaid-icons.mjs — do not edit manually
export const icons = ${JSON.stringify({prefix: pack, icons}, null, '\t')} as const;
`;

	fs.writeFileSync(outFile, output, 'utf-8');
	console.log(
		`Generated ${Object.keys(icons).length} icons → ${path.relative(process.cwd(), outFile)}`
	);

	barrelLines.push(
		`export {icons as ${pack}Icons} from './${pack}/icons.generated';`
	);
}

// Write barrel index
const barrelFile = path.join(logosDir, 'index.ts');
fs.writeFileSync(barrelFile, barrelLines.join('\n') + '\n', 'utf-8');
console.log(`Generated barrel → ${path.relative(process.cwd(), barrelFile)}`);
