# Install single-container Sourcegraph with Docker on AWS

This tutorial shows you how to deploy [single-container Sourcegraph with Docker](/self-hosted/deploy/docker-single-container/) to a single EC2 instance on AWS.

> NOTE: We _do not_ recommend using this method for a production instance. If deploying a production instance, see [our recommendations](/self-hosted/deploy/) for how to choose a deployment type that suits your needs. We recommend [Docker Compose](/self-hosted/deploy/docker-compose/aws) for most initial production deployments.

<Callout type="note">
	For security, please follow [Amazon best
	practices](https://docs.aws.amazon.com/accounts/latest/reference/best-practices-root-user.html)
	and _do not deploy Sourcegraph using your AWS account root user._
</Callout>

## IAM permissions

To deploy Sourcegraph on AWS, you will need an IAM user or role with the following permissions. Following the [principle of least privilege](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege), only grant the minimum permissions required for deployment and operation.

### Required IAM policy for deployment

The IAM user or role performing the deployment needs the following permissions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "EC2InstanceManagement",
      "Effect": "Allow",
      "Action": [
        "ec2:RunInstances",
        "ec2:DescribeInstances",
        "ec2:DescribeInstanceStatus",
        "ec2:TerminateInstances",
        "ec2:StartInstances",
        "ec2:StopInstances"
      ],
      "Resource": "*"
    },
    {
      "Sid": "EC2NetworkManagement",
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeSecurityGroups",
        "ec2:CreateSecurityGroup",
        "ec2:AuthorizeSecurityGroupIngress",
        "ec2:DescribeVpcs",
        "ec2:DescribeSubnets"
      ],
      "Resource": "*"
    },
    {
      "Sid": "KeyPairManagement",
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeKeyPairs",
        "ec2:CreateKeyPair"
      ],
      "Resource": "*"
    }
  ]
}
```

**Purpose of each permission set:**

- **EC2InstanceManagement**: Allows you to create, start, stop, and manage the EC2 instance that runs the Sourcegraph Docker container. These are the basic permissions required for instance lifecycle operations.

- **EC2NetworkManagement**: Enables creation and configuration of security groups (firewall rules) to control network access to your Sourcegraph instance, allowing HTTP/HTTPS traffic while protecting against unauthorized access.

- **KeyPairManagement**: Allows management of SSH key pairs for secure remote access to your EC2 instance for troubleshooting and maintenance tasks.

### IAM role for the EC2 instance (optional)

If you plan to use [external services](/self-hosted/external-services/) such as [AWS RDS for PostgreSQL](https://aws.amazon.com/rds/), [Amazon ElastiCache](https://aws.amazon.com/elasticache/redis/), or [S3](https://aws.amazon.com/s3/) for persistence, create an [IAM role for EC2](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html) and attach it to your Sourcegraph instance during launch.

The EC2 instance role should only include permissions for the specific AWS services that Sourcegraph will access (e.g., S3 buckets, RDS databases, ElastiCache clusters).

---

## Deploy to EC2

-   Click **Launch Instance** from your [EC2 dashboard](https://console.aws.amazon.com/ec2/v2/home).
-   Select the Amazon Linux 2 AMI (HVM), SSD Volume Type.
-   Select an appropriate instance size (we recommend `t2.medium` or `t2.large`, depending on team size and number of repositories/languages enabled), then **Next: Configure Instance Details**
-   Ensure the **Auto-assign Public IP** option is "Enable". This ensures your instance is accessible to the Internet.
-   Add the following user data (as text) in the **Advanced Details** section:

    ```
    #cloud-config
    repo_update: true
    repo_upgrade: all

    runcmd:
    # Create the directory structure for Sourcegraph data
    - mkdir -p /home/ec2-user/.sourcegraph/config
    - mkdir -p /home/ec2-user/.sourcegraph/data

    # Install, configure, and enable Docker
    - yum update -y
    - amazon-linux-extras install docker
    - systemctl enable --now --no-block docker
    - sed -i -e 's/1024/10240/g' /etc/sysconfig/docker
    - sed -i -e 's/4096/40960/g' /etc/sysconfig/docker
    - usermod -a -G docker ec2-user

    # Install and run Sourcegraph. Restart the container upon subsequent reboots
    - [ sh, -c, 'docker run -d --publish 80:7080 --publish 443:7080 --publish 127.0.0.1:3370:3370 --restart unless-stopped --volume /home/ec2-user/.sourcegraph/config:/etc/sourcegraph --volume /home/ec2-user/.sourcegraph/data:/var/opt/sourcegraph sourcegraph/server:{CURRENT_VERSION_NO_V}' ]
    ```

-   Select **Next: ...** until you get to the **Configure Security Group** page. Then add the following rules:
    -   Default **HTTP** rule: port range `80`, source `0.0.0.0/0, ::/0`
    -   Default **HTTPS** rule: port range `443`, source `0.0.0.0/0, ::/0`
        -   (NOTE: additional work will be required later on to [configure NGINX to support SSL](/self-hosted/http-https-configuration#nginx-ssl-https-configuration))
-   Launch your instance, then navigate to its public IP in your browser. (This can be found by navigating to the instance page on EC2 and looking in the "Description" panel for the "IPv4 Public IP" value.) You may have to wait a minute or two for the instance to finish initializing before Sourcegraph becomes accessible. You can monitor the status by SSHing into the EC2 instance and viewing the logs:

    ```
    docker logs $(docker ps | grep sourcegraph/server | awk '{ print $1 }')
    ```

-   If you have configured a domain name to point to the IP, configure `externalURL` to reflect that.

---

## Update your Sourcegraph version

To update to the most recent version of Sourcegraph (X.Y.Z), SSH into your instance and run the following:

```bash
docker ps # get the $CONTAINER_ID of the running sourcegraph/server container
docker rm -f $CONTAINER_ID
docker run docker run -d --publish 80:7080 --publish 443:7080 --restart unless-stopped --volume /home/ec2-user/.sourcegraph/config:/etc/sourcegraph --volume /home/ec2-user/.sourcegraph/data:/var/opt/sourcegraph sourcegraph/server:X.Y.Z
```

---

## Using an external database for persistence

The Docker container has its own internal PostgreSQL and Redis databases. To preserve this data when you kill and recreate the container, you can [use external services](/self-hosted/external-services/) for persistence, such as [AWS RDS for PostgreSQL](https://aws.amazon.com/rds/), [Amazon ElastiCache](https://aws.amazon.com/elasticache/redis/), and [S3](https://aws.amazon.com/s3/) for storing user uploads.

> NOTE: Use of external databases requires [Sourcegraph Enterprise](https://about.sourcegraph.com/pricing).
