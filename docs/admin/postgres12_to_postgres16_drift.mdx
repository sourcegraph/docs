# Postgres 12 to 16 Upgrade Drift

This document describes drift introduced by the Postgres 12 to 16 upgrade.

## Background

In postgres 5.10.0 Sourcegraph introduced new built in database containers based on postgres 16 rather than postgres 12. During the upgrade of postgres from 12 to 16 postgres upgrade utilities makes some changes to the database schema. These changes are accounted for in Sourcegraph 5.10.0 expected schema, but not in earlier expected schemas. This can cause issues for Sourcegraphs Migrator and Frontend services during upgrades as they expect a certain schema state in the databases before they begin an upgrade, but also start the new postgres 16 container images before conducting schema migrations.

### Example Error

During a multiversion upgrade using the migrator `upgrade` cli command you attempt an upgrade from v5.5.0 to v5.10.0
1. First you bring down the containers with `docker-compose down --remove-orphans` 
2. Then you git checkout the v5.10.0 tag:
```
‚ûú  docker-compose git:(v5.5.0) ‚úó git co v5.10.0
Previous HEAD position was 7b2c346 promote-release: v5.5.0
HEAD is now at c53c52c promote-release: v5.10.0
```
3. You alter the `docekr-compose.yml` file setting the upgrade command on the migrator service:
```yaml
    command: ['upgrade', '-from', '5.5.0', '-to', '5.10.0']
```
4. finally you run the multiversion upgrade with `docker-compose up migrator`, recieving this error:
```
‚ûú  docker-compose git:(v5.10.0) ‚úó docker-compose up migrator
WARN[0000] /Users/doombot/deploy-sourcegraph-docker/docker-compose/docker-compose.yaml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion
[+] Running 15/15
 ‚úî pgsql Pulled                                                                                                                                                                                                  1.7s
   ‚úî f4b0c2198d38 Already exists                                                                                                                                                                                 0.0s
   ‚úî 7e424d9f0a75 Pull complete                                                                                                                                                                                  2.2s
   ‚úî a89488faff46 Pull complete                                                                                                                                                                                  0.5s
   ‚úî a3f7528cd0f1 Pull complete                                                                                                                                                                                  0.5s
 ‚úî migrator Pulled                                                                                                                                                                                               4.8s
   ‚úî 2db071b38aaa Pull complete                                                                                                                                                                                  2.0s
   ‚úî 2d3731ee55ab Pull complete                                                                                                                                                                                  3.3s
   ‚úî 46ec33b86cdc Pull complete                                                                                                                                                                                  3.3s
   ‚úî 80d0f6d8a855 Pull complete                                                                                                                                                                                  3.6s
 ‚úî codeintel-db Pulled                                                                                                                                                                                           2.0s
 ‚úî codeinsights-db Pulled                                                                                                                                                                                        4.2s
   ‚úî cae37c253ac2 Already exists                                                                                                                                                                                 0.0s
   ‚úî 7c7182fbda5c Pull complete                                                                                                                                                                                  2.0s
   ‚úî 475b06ff516a Pull complete                                                                                                                                                                                  2.2s
[+] Running 9/4
 ‚úî Network docker-compose_sourcegraph                                                                                                                             Create...                                      0.0s
 ‚úî Container codeinsights-db                                                                                                                                      Created                                        0.3s
 ‚úî Container codeintel-db                                                                                                                                         Created                                        0.3s
 ‚úî Container pgsql                                                                                                                                                Created                                        0.3s
 ! codeinsights-db The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested                                                0.0s
 ! pgsql The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested                                                          0.0s
 ! codeintel-db The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested                                                   0.0s
 ‚úî Container migrator                                                                                                                                             Created                                        0.0s
 ! migrator The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested                                                       0.0s
Attaching to migrator
migrator  | ‚ú± Sourcegraph migrator 5.10.0
migrator  | ‚ö†Ô∏è Failed to check for migrator update: unexpected status code 404. Continuing...
migrator  | Attempting connection to frontend...
migrator  | ‚úÖ Connection to frontend succeeded
migrator  | Attempting connection to frontend...
migrator  | ‚úÖ Connection to frontend succeeded
migrator  | Attempting connection to codeintel...
migrator  | ‚úÖ Connection to codeintel succeeded
migrator  | Attempting connection to codeinsights...
migrator  | ‚úÖ Connection to codeinsights succeeded
migrator  | ‚ùå Schema drift detected for frontend
migrator  | üí° Before continuing with this operation, run the migrator's drift command and follow instructions to repair the schema to the expected current state. See https://sourcegraph.com/docs/admin/updates/migrator/schema-drift for additional instructions.
migrator  |
migrator  | {"SeverityText":"FATAL","Timestamp":1732748464156817455,"InstrumentationScope":"migrator","Caller":"migrator/main.go:24","Function":"main.main","Body":"database drift detected","Resource":{"service.name":"migrator","service.version":"5.10.0","service.instance.id":"2ff6ba18-8fcd-44a3-93f6-814e25afaec5"},"Attributes":{}}
migrator exited with code 1
```

This procedure may look different depending on your deployment type, but the pattern is the same, if the database version upgrade happens before migrator starts the migrator will detect a difference in the expected state of the v5.9 schema and exit before running the upgrade.

### Expected Drift

The following drift is expected in the `frontend` or `pgsql` database if the postgres 16 upgrade has been applied while the application is still on a pre-5.10.0 version:

```golang

```

## Known Issues

### Automatic Multi-Version Upgrade Failures

When performing an [automatic multi-version upgrade](/admin/updates/automatic) to Sourcegraph 5.10+, the upgrade may fail if:

1. Your Postgres databases were upgraded from version 12 to 16 before the Sourcegraph application upgrade
2. The schema changes from the Postgres upgrade don't match what the migrator expects for version 5.9 or earlier

### Manual Migrator Upgrade Failures 

Similar issues can occur when using the [migrator CLI for multi-version upgrades](/admin/deploy/kubernetes/upgrade#multi-version-upgrades).

## Solutions

### Option 1: Set Drift Override Flag

To bypass drift detection during automatic upgrades, set the following environment variable on the `sourcegraph-frontend` container:

```yaml
environment:
  - SRC_AUTOUPGRADE_IGNORE_DRIFT=true
