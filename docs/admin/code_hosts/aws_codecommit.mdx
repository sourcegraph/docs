# AWS CodeCommit

<TierCallout>
  Supported on [Enterprise](/pricing/enterprise) plans.
  <user>
    Available via the Web app.
  </user>
</TierCallout>

Site admins can sync Git repositories hosted on [AWS CodeCommit](https://aws.amazon.com/codecommit/) with Sourcegraph so that users can search and navigate the repositories.

To connect AWS CodeCommit to Sourcegraph:

1. Go to **Site admin > Manage code hosts > Add repositories**
1. Select **AWS CodeCommit repositories**.
1. Configure the connection to AWS CodeCommit using the action buttons above the text field, and additional fields can be added using `Cmd/Ctrl+Space` for auto-completion. See the [configuration documentation below](#configuration).
1. Press **Add repositories**.

## AWS CodeCommit Git credentials

Since version **3.4** of Sourcegraph, the AWS CodeCommit service **requires** [Git credentials](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_ssh-keys.html#git-credentials-code-commit) in order to clone repositories via HTTPS. Git credentials consist of a username and a password that you can create in AWS IAM.

For detailed instructions on how to create the credentials in IAM, see: [Setup for HTTPS Users Using Git Credentials](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-gc.html)

<Callout type="info"> We don't plan to implement and support authentication roles for AWS CodeCommit such as IAM Roles, for example AssumeRole or IAM Anywhere. We encourage CodeCommit customers to continue Sourcegraph's provisions as shown in the schema below.</Callout>

## Configuration

AWS CodeCommit connections support the following configuration options, which are specified in the JSON editor in the site admin "Manage code hosts" area.

{/* <div markdown-func=jsonschemadoc jsonschemadoc:path="admin/code_hosts/aws_codecommit.schema.json">[View page on our docs](/admin/code_hosts/aws_codecommit) to see rendered content.</div> */}

### admin/code_hosts/aws_codecommit.schema.json

{/* SCHEMA_SYNC_START: admin/code_hosts/aws_codecommit.schema.json */}
{/* WARNING: This section is auto-generated during releases. Do not edit manually. */}
{/* Last updated: 2025-07-01T21:34:12Z via sourcegraph/sourcegraph@v6.5.1211 */}
```json
{
	"accessKeyID": null,
	"exclude": null,
	"gitCredentials": {
		"password": null,
		"username": null
	},
	"gitSSHCipher": null,
	"gitSSHCredential": null,
	"gitSSHKeyID": null,
	"gitURLType": "http",
	"initialRepositoryEnablement": false,
	"maxDeletions": 0,
	"region": "us-east-1",
	"repositoryPathPattern": "{name}",
	"secretAccessKey": null
}
```
{/* SCHEMA_SYNC_END: admin/code_hosts/aws_codecommit.schema.json */}
## Configuration Notes

### Git Credentials Requirement
AWS CodeCommit **requires** Git credentials for HTTPS authentication since Sourcegraph version 3.4:
- Git credentials consist of a username and password generated in AWS IAM
- These are different from your regular AWS access keys
- Follow the [AWS Git credentials setup guide](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-gc.html) for detailed instructions

### Repository Path Patterns
The `repositoryPathPattern` field allows customization of repository URLs within Sourcegraph:
- Default pattern: `"{name}"` results in URLs like `src.example.com/myrepo`
- Region-specific pattern: `"git-codecommit.us-west-1.amazonaws.com/{name}"` for better organization
- Ensure patterns generate unique repository names to avoid conflicts

### Authentication Methods
AWS CodeCommit supports both HTTPS and SSH authentication:
- **HTTPS**: Uses Git credentials (username/password) - recommended for simplicity
- **SSH**: Uses SSH key pairs - requires additional key management setup

## Security Considerations

### IAM Permissions
- The AWS access key must have the **AWSCodeCommitReadOnly** IAM policy attached minimum
- Consider using more restrictive custom policies that limit access to specific repositories
- Never use root account credentials - create dedicated IAM users for Sourcegraph

### Credential Storage
- Store AWS access keys and secrets securely using Sourcegraph's secret management
- For SSH setups, ensure private keys are base64 encoded and properly secured
- Regularly rotate AWS access keys according to security best practices

### Network Access
- Ensure Sourcegraph can reach AWS CodeCommit endpoints in your configured region
- Consider VPC endpoints for private network access to CodeCommit
- Review AWS CloudTrail logs for monitoring repository access

### SSH Key Security
- Generate SSH keys without passphrases for automated access
- Store private keys securely and base64 encode them for configuration
- Regularly rotate SSH keys and update configurations accordingly

## Common Examples

### Basic HTTPS Configuration
```json
{
  "accessKeyID": "AKIA...",
  "secretAccessKey": "your-secret-key", 
  "region": "us-east-1",
  "gitCredentials": {
    "username": "git-username",
    "password": "git-password"
  },
  "repositoryPathPattern": "{name}"
}
```

### Region-Specific Setup
```json
{
  "accessKeyID": "AKIA...",
  "secretAccessKey": "your-secret-key",
  "region": "eu-central-1", 
  "gitCredentials": {
    "username": "git-username",
    "password": "git-password"
  },
  "repositoryPathPattern": "git-codecommit.eu-central-1.amazonaws.com/{name}"
}
```

### SSH Configuration
```json
{
  "accessKeyID": "AKIA...",
  "secretAccessKey": "your-secret-key",
  "region": "us-west-1",
  "gitURLType": "ssh",
  "gitSSHKeyID": "APKA...",
  "gitSSHCredential": {
    "privateKey": "LS0tLS1CRUdJTi...",
    "passphrase": ""
  }
}
```

### Selective Repository Sync
```json
{
  "accessKeyID": "AKIA...",
  "secretAccessKey": "your-secret-key",
  "region": "us-east-1",
  "gitCredentials": {
    "username": "git-username", 
    "password": "git-password"
  },
  "exclude": [
    {"name": "internal-temp-repo"},
    {"name": "archived-project"}
  ]
}
```

## Best Practices

### Performance and Reliability
- **Regional Deployment**: Deploy Sourcegraph in the same AWS region as your CodeCommit repositories for optimal performance
- **Repository Exclusion**: Use the `exclude` field to avoid syncing temporary or archived repositories
- **Connection Monitoring**: Regularly verify that your AWS credentials remain valid and have appropriate permissions

### Operational Management
- **Credential Rotation**: Implement regular rotation of AWS access keys and Git credentials
- **Monitoring**: Set up CloudWatch alarms for CodeCommit API usage and authentication failures
- **Backup Strategy**: Ensure your repository syncing strategy aligns with your backup and disaster recovery plans

### Deployment Considerations
- **Docker Deployments**: For SSH setups, properly mount SSH configuration files into containers
- **Kubernetes Deployments**: Use secrets for credential management and configure SSH access appropriately
- **Container Restart**: Plan for service restarts when updating SSH keys or credentials

### Migration and Setup
- **Testing**: Always test your configuration with a small subset of repositories first
- **Documentation**: Document your repository path patterns and credential management processes
- **Access Validation**: Verify Sourcegraph can access all intended repositories before full deployment

### Mounting SSH keys into the container

1. Copy all the files at your `$HOME/.ssh directory` to `$HOME/.sourcegraph/config/ssh` directory. See [docs](/admin/deploy/docker-single-container/#ssh-authentication-config-keys-knownhosts) for more information about our ssh file system.
    1. Read our [guide here](/admin/deploy/docker-compose/#git-ssh-configuration) for Docker Compose deployments
    1. Read our [guide here](/admin/deploy/kubernetes/configure#ssh-for-cloning) for Kubernetes deployments
1. Start (or restart) the container.
1. Connect Sourcegraph to AWS CodeCommit by going to **Sourcegraph > Site Admin > Manage code hosts > Generic Git host** and add the following:

```json
"url": "ssh://git-codecommit.us-west-1.amazonaws.com", //Please replace the 'us-east-1' region with yours
  "repos": [
    "v1/repos/REPO_NAME_1",
    "v1/repos/REPO_NAME_2",
  ]
```
