# Bitbucket Server/Bitbucket Data Center

<TierCallout>
  Supported on [Enterprise](/pricing/enterprise) plans.
  <user>
    Available via the Web app.
  </user>
</TierCallout>

Site admins can sync Git repositories hosted on [Bitbucket Server](https://www.atlassian.com/software/bitbucket/server) or [Bitbucket Data Center](https://www.atlassian.com/enterprise/data-center/bitbucket) with Sourcegraph so that users can search and navigate their repositories.

To connect Bitbucket Server / Bitbucket Data Center to Sourcegraph:

1. Go to **Site admin > Manage code hosts > Add repositories**
1. Select **Bitbucket Server / Bitbucket Data Center**.
1. Configure the connection to Bitbucket Server / Bitbucket Data Center using the action buttons above the text field, and additional fields can be added using <kbd>Cmd/Ctrl+Space</kbd> for auto-completion. See the [configuration documentation below](#configuration).
1. Press **Add repositories**.

Also consider installing the [Sourcegraph Bitbucket Server plugin](/integration/bitbucket_server#sourcegraph-bitbucket-server-plugin) which enables native code navigation for every Bitbucket user when browsing code and reviewing pull requests, allows for faster permission syncing between Sourcegraph and Bitbucket Server / Bitbucket Data Center and adds support for webhooks to Bitbucket Server / Bitbucket Data Center.

## Access token permissions

Sourcegraph requires a Bitbucket Server / Bitbucket Data Center personal access token with **read** permissions to sync repositories.

When using [batch changes](/batch-changes/) the access token needs **write** permissions on the project and repository level. See "[Code host interactions in batch changes](/batch-changes/permissions-in-batch-changes#code-host-interactions-in-batch-changes)" for details.

You can create a personal access token at `https://[your-bitbucket-hostname]/plugins/servlet/access-tokens/add`. Also set the corresponding `username` field.

For Bitbucket Server instances that don't support personal access tokens (Bitbucket Server version 5.4 and older), specify user-password credentials in the `username` and `password` fields.

## Repository syncing

There are four fields for configuring which repositories are mirrored:

- [`repos`](/admin/code_hosts/bitbucket_server#configuration)
  - A list of repositories in `projectKey/repositorySlug` format. The order determines the order in which we sync repository metadata and is safe to change.
- [`repositoryQuery`](/admin/code_hosts/bitbucket_server#configuration)
  - A list of strings with some pre-defined options (`none`, `all`), and/or a [Bitbucket Server / Bitbucket Data Center Repo Search Request Query Parameters](https://docs.atlassian.com/bitbucket-server/rest/6.1.2/bitbucket-rest.html#idp355).
- [`exclude`](/admin/code_hosts/bitbucket_server#configuration)
  - A list of repositories to exclude which takes precedence over the `repos`, and `repositoryQuery` fields.
- [`excludePersonalRepositories`](/admin/code_hosts/bitbucket_server#configuration)
  - With this enabled, Sourcegraph will exclude any personal repositories from being imported, even if it has access to them.

## Webhooks

Using the `webhooks` property on the external service has been deprecated.

Please consult [this page](/admin/config/webhooks/incoming) in order to configure webhooks.

## Repository permissions

Enforcing Bitbucket Server / Bitbucket Data Center permissions can be configured via the `authorization` setting in its configuration.

> NOTE: It can take some time to complete full cycle of repository permissions sync if you have a large number of users or repositories. [See sync duration time](/admin/permissions/syncing#sync-duration) for more information.

> NOTE: Sourcegraph can only sync permissions for personal repositories on Bitbucket Server / Bitbucket Data Center when the Sourcegraph [Bitbucket Server plugin](/integration/bitbucket_server) is installed.

### Prerequisites

1. You have the exact same user accounts, **with matching usernames**, in Sourcegraph and Bitbucket Server / Bitbucket Data Center. This can be accomplished by configuring an [external authentication provider](/admin/auth/) that mirrors user accounts from a central directory like LDAP or Active Directory. The same should be done on Bitbucket Server / Bitbucket Data Center with [external user directories](https://confluence.atlassian.com/bitbucketserver/external-user-directories-776640394.html).
1. Ensure you have set `auth.enableUsernameChanges` to **`false`** in the [site config](/admin/config/site_config) to prevent users from changing their usernames and **escalating their privileges**.


### Setup

Repository permissions for Bitbucket Server / Bitbucket Data Center can be configured via OAuth1 or OAuth2. OAuth2 is the recommended method.

#### OAuth2

You'll first need to [configure Bitbucket Server as an auth provider](/admin/auth/#bitbucket-server). Next, in your Bitbucket Server code host connection, add the following `authorization` settings:

    ```json
    {
      // Other config goes here
      "authorization": {
        "oauth2": true
      }
    }
    ```

Once a user has connected their Bitbucket Server account, either by signing-in via Bitbucket Server or by connecting the account on their **Settings** > **Account security** page, their OAuth token will be used to sync their repository permissions.

#### OAuth1

This section walks you through the process of setting up an *Application Link between Sourcegraph and Bitbucket Server / Bitbucket Data Center* and configuring the Sourcegraph Bitbucket Server / Bitbucket Data Center configuration with `authorization` settings. It assumes the above prerequisites are met.

As an admin user, go to the "Application Links" page. You can use the sidebar navigation in the admin dashboard, or go directly to [https://bitbucketserver.example.com/plugins/servlet/applinks/listApplicationLinks](https://bitbucketserver.example.com/plugins/servlet/applinks/listApplicationLinks).

> NOTE: There has been some [changes to the flow in Bitbucket v7.20](https://confluence.atlassian.com/bitbucketserver/bitbucket-data-center-and-server-7-20-release-notes-1101934428.html). Depending on your Bitbucket version, the setup is slightly different. Please follow the instructions for the correct version of Bitbucket below:

- [Bitbucket v7.20 and above](#bitbucket-v720-and-above)
- [Bitbucket v7.19 and below](#bitbucket-v719-and-below)

#### Bitbucket v7.20 and above

{/* <!-- Duplicating content in this section and in 7.19 on purpose. If we decide to implement OAuth2 support, the 7.20 instructions would be much more different than now --> */}

1. Click on **Create link** button.
    ![Screenshot of Bitbucket Application Links page.](https://storage.googleapis.com/sourcegraph-assets/docs/images/administration/config/external-services/bitbucket_server/application_links_landing_page.png)
1. Make sure **Atlassian product** is selected (This will probably look confusing, but it is the only way to setup legacy OAuth app that Sourcegraph supports).
Write Sourcegraph's external URL in the **Application URL** field and click **Continue**. Click **Continue** on the next screen again, even if Bitbucket Server / Bitbucket Data Center warns you about the given URL not responding.
    ![Screenshot of Bitbucket Create Link form.](https://storage.googleapis.com/sourcegraph-assets/docs/images/administration/config/external-services/bitbucket_server/create_link_part_1.png)
1. Write `Sourcegraph` as the *Application Name* and select `Generic Application` as the *Application Type*. Leave everything else unset and click **Continue**.
    ![Screenshot of second part of Bitbucket Create Link form.](https://storage.googleapis.com/sourcegraph-assets/docs/images/administration/config/external-services/bitbucket_server/create_link_part_2.png)
1. Now click the **Edit** button in the `Sourcegraph` Application Link that you just created and select the **Incoming Authentication** panel.
    ![Screenshot of first part of Bitbucket Edit Link form.](https://storage.googleapis.com/sourcegraph-assets/docs/images/administration/config/external-services/bitbucket_server/edit_link_part_1.png)
1. Generate a *Consumer Key* in your terminal with `echo sourcegraph$(openssl rand -hex 16)`. Copy this command's output and paste it in the *Consumer Key* field. Write `Sourcegraph` in the *Consumer Name* field.
    ![Screenshot of second part of Bitbucket Edit Link form.](https://storage.googleapis.com/sourcegraph-assets/docs/images/administration/config/external-services/bitbucket_server/edit_link_part_2.png)
1. Generate an RSA key pair in your terminal with `ssh-keygen -t rsa -b 4096 -o -a 100 -f sourcegraph.pem -m PEM && openssl rsa -in sourcegraph.pem -pubout > sourcegraph.pub`. Note that the private key must be in PKCS#1 format. Copy the contents of `sourcegraph.pub` and paste them in the *Public Key* field.
    ![Screenshot of third part of Bitbucket Edit Link form.](https://storage.googleapis.com/sourcegraph-assets/docs/images/administration/config/external-services/bitbucket_server/edit_link_part_3.png)
1. Scroll to the bottom and check the ***Allow 2-Legged OAuth*** checkbox, then write your admin account's username (this **must** match the `username` used in the external service configuration. In an instance where you may choose to use a service account, make sure that it has admin privileges.) in the *Execute as* field and, lastly, check the ***Allow user impersonation through 2-Legged OAuth*** checkbox. Press **Save**.
    ![Screenshot of last part of Bitbucket Edit Link form.](https://storage.googleapis.com/sourcegraph-assets/docs/images/administration/config/external-services/bitbucket_server/edit_link_part_4.png)
1. Go to your Sourcegraph's *Manage code hosts* page (i.e. `https://sourcegraph.example.com/site-admin/external-services`) and either edit or create a new *Bitbucket Server / Bitbucket Data Center* connection. Add the following settings:
    ```json
    {
      // Other config goes here
      "authorization": {
        "identityProvider": {
          "type": "username"
        },
        "oauth": {
          "consumerKey": "<KEY GOES HERE>",
          "signingKey": "<KEY GOES HERE>"
        }
      }
    }
    ```
1. Copy the *Consumer Key* you generated before to the `oauth.consumerKey` field and the output of the command `base64 sourcegraph.pem | tr -d '\n'` to the `oauth.signingKey` field. Finally, **save the configuration**. You're done!

#### Bitbucket v7.19 and below

1. Write Sourcegraph's external URL in the text area (e.g. `https://sourcegraph.example.com`) and click **Create new link**.
    <img src="https://imgur.com/Hg4bzOf.png" />
1. Click **Continue** even if Bitbucket Server / Bitbucket Data Center warns you about the given URL not responding.
    <img src="https://imgur.com/x6vFKIL.png" />
1. Write `Sourcegraph` as the *Application Name* and select `Generic Application` as the *Application Type*. Leave everything else unset and click **Continue**.
    <img src="https://imgur.com/161rbB9.png" />
1. Now click the edit button in the `Sourcegraph` Application Link that you just created and select the `Incoming Authentication` panel.
    <img src="https://imgur.com/sMGmzhH.png" />
1. Generate a *Consumer Key* in your terminal with `echo sourcegraph$(openssl rand -hex 16)`. Copy this command's output and paste it in the *Consumer Key* field. Write `Sourcegraph` in the *Consumer Name* field.
    <img src="https://imgur.com/1kK2Y5x.png" />
1. Generate an RSA key pair in your terminal with `openssl genrsa -out sourcegraph.pem 4096 && openssl rsa -in sourcegraph.pem -pubout > sourcegraph.pub`. Copy the contents of `sourcegraph.pub` and paste them in the *Public Key* field.
    <img src="https://imgur.com/YHm1uSr.png" />
1. Scroll to the bottom and check the *Allow 2-Legged OAuth* checkbox, then write your admin account's username in the *Execute as* field and, lastly, check the *Allow user impersonation through 2-Legged OAuth* checkbox. Press **Save**.
    <img src="https://imgur.com/1qxEAye.png" />
1. Go to your Sourcegraph's *Manage code hosts* page (i.e. `https://sourcegraph.example.com/site-admin/external-services`) and either edit or create a new *Bitbucket Server / Bitbucket Data Center* connection. Add the following settings:
    ```json
    {
      // Other config goes here
      "authorization": {
        "identityProvider": {
          "type": "username"
        },
        "oauth": {
          "consumerKey": "<KEY GOES HERE>",
          "signingKey": "<KEY GOES HERE>"
        }
      }
    }
    ```
1. Copy the *Consumer Key* you generated before to the `oauth.consumerKey` field and the output of the command `base64 sourcegraph.pem | tr -d '\n'` to the `oauth.signingKey` field. Finally, **save the configuration**. You're done!

### Fast permission sync with Bitbucket Server plugin

By installing the [Bitbucket Server plugin](/integration/bitbucket_server), you can make use of the fast permission sync feature that allows using Bitbucket Server / Bitbucket Data Center permissions on larger instances.

### Fast permission syncing

With the [Sourcegraph Bitbucket Server plugin](/integration/bitbucket_server#sourcegraph-bitbucket-server-plugin) you can enable fast permission syncing:

1. Connect Bitbucket Server / Bitbucket Data Center to Sourcegraph (_see instructions above_).
1. Follow the [instructions to set up repository permissions](#repository-permissions) with Bitbucket Server / Bitbucket Data Center.
1. Install the [Sourcegraph Bitbucket Server plugin](/integration/bitbucket_server#sourcegraph-bitbucket-server-plugin) on your Bitbucket Server / Bitbucket Data Center instance.
1. In Sourcegraph, go to **Site admin > Manage code hosts** and edit the Bitbucket Server / Bitbucket Data Center configuration.
1. Add the `"plugin.permissions"` property:

```json
{
  // [...]
  "plugin": {
    "permissions": "enabled"
  }
}
```

### Authentication for older Bitbucket Server / Bitbucket Data Center versions

Bitbucket Server / Bitbucket Data Center versions older than v5.5 require specifying a less secure username and password combination, as those versions of Bitbucket Server / Bitbucket Data Center do not support [personal access tokens](https://confluence.atlassian.com/bitbucketserver/personal-access-tokens-939515499.html).

### HTTPS cloning

Sourcegraph by default clones repositories from your Bitbucket Server / Bitbucket Data Center via HTTP(S), using the access token or account credentials you provide in the configuration. The [`username`](/admin/code_hosts/bitbucket_server#configuration) field is always used when cloning, so it is required.

## Repository labels

Sourcegraph will mark repositories as archived if they have the `archived` label on Bitbucket Server / Bitbucket Data Center. You can exclude these repositories in search with `archived:no` [search syntax](/code-search/queries).

## Internal rate limits

See [Internal rate limits](/admin/code_hosts/rate_limits#internal-rate-limits).

## Configuration

Bitbucket Server / Bitbucket Data Center connections support the following configuration options, which are specified in the JSON editor in the site admin "Manage code hosts" area.

{/* <div markdown-func=jsonschemadoc jsonschemadoc:path="admin/code_hosts/bitbucket_server.schema.json">[View page on our docs](/admin/code_hosts/bitbucket_server) to see rendered content.</div> */}

### admin/code_hosts/bitbucket_server.schema.json

{/* SCHEMA_SYNC_START: admin/code_hosts/bitbucket_server.schema.json */}
{/* WARNING: This section is auto-generated during releases. Do not edit manually. */}
{/* Last updated: 2025-07-01T19:22:24Z via sourcegraph/sourcegraph@v6.5.1211 */}
```json
{
	"$id": "bitbucket_server.schema.json#",
	"$schema": "http://json-schema.org/draft-07/schema#",
	"additionalProperties": false,
	"allowComments": true,
	"definitions": {
		"UsernameIdentity": {
			"additionalProperties": false,
			"properties": {
				"type": {
					"const": "username",
					"type": "string"
				}
			},
			"required": [
				"type"
			],
			"title": "BitbucketServerUsernameIdentity",
			"type": "object"
		}
	},
	"description": "Configuration for a connection to Bitbucket Server / Bitbucket Data Center.",
	"oneOf": [
		{
			"properties": {
				"password": {
					"type": "null"
				}
			},
			"required": [
				"token"
			]
		},
		{
			"properties": {
				"token": {
					"type": "null"
				}
			},
			"required": [
				"password"
			]
		}
	],
	"properties": {
		"authorization": {
			"additionalProperties": false,
			"description": "If non-null, enforces Bitbucket Server / Bitbucket Data Center repository permissions.",
			"oneOf": [
				{
					"required": [
						"identityProvider",
						"oauth"
					]
				},
				{
					"required": [
						"oauth2"
					]
				}
			],
			"properties": {
				"identityProvider": {
					"!go": {
						"taggedUnionType": true
					},
					"description": "The source of identity to use when computing permissions. This defines how to compute the Bitbucket Server / Bitbucket Data Center identity to use for a given Sourcegraph user. When 'username' is used, Sourcegraph assumes usernames are identical in Sourcegraph and Bitbucket Server / Bitbucket Data Center accounts and `auth.enableUsernameChanges` must be set to false for security reasons.",
					"oneOf": [
						{
							"$ref": "#/definitions/UsernameIdentity"
						}
					],
					"properties": {
						"type": {
							"enum": [
								"username"
							],
							"type": "string"
						}
					},
					"required": [
						"type"
					],
					"title": "BitbucketServerIdentityProvider",
					"type": "object"
				},
				"oauth": {
					"additionalProperties": false,
					"description": "OAuth configuration specified when creating the Bitbucket Server / Bitbucket Data Center Application Link with incoming authentication. Two Legged OAuth with 'ExecuteAs=admin' must be enabled as well as user impersonation.",
					"properties": {
						"consumerKey": {
							"description": "The OAuth consumer key specified when creating the Bitbucket Server / Bitbucket Data Center Application Link with incoming authentication.",
							"minLength": 1,
							"type": "string"
						},
						"signingKey": {
							"description": "Base64 encoding of the OAuth PEM encoded RSA private key used to generate the public key specified when creating the Bitbucket Server / Bitbucket Data Center Application Link with incoming authentication.",
							"minLength": 1,
							"type": "string"
						}
					},
					"required": [
						"consumerKey",
						"signingKey"
					],
					"title": "BitbucketServerOAuth",
					"type": "object"
				},
				"oauth2": {
					"type": "boolean"
				}
			},
			"title": "BitbucketServerAuthorization",
			"type": "object"
		},
		"certificate": {
			"description": "TLS certificate of the Bitbucket Server / Bitbucket Data Center instance. This is only necessary if the certificate is self-signed or signed by an internal CA. To get the certificate run `openssl s_client -connect HOST:443 -showcerts \u003c /dev/null 2\u003e /dev/null | openssl x509 -outform PEM`. To escape the value into a JSON string, you may want to use a tool like https://json-escape-text.now.sh.",
			"examples": [
				"-----BEGIN CERTIFICATE-----\n..."
			],
			"pattern": "^-----BEGIN CERTIFICATE-----\n",
			"type": "string"
		},
		"exclude": {
			"description": "A list of repositories to never mirror from this Bitbucket Server / Bitbucket Data Center instance. Takes precedence over \"repos\" and \"repositoryQuery\".\n\nSupports excluding by name ({\"name\": \"projectKey/repositorySlug\"}) or by ID ({\"id\": 42}).",
			"examples": [
				[
					{
						"name": "myproject/myrepo"
					},
					{
						"id": 42
					}
				],
				[
					{
						"name": "myproject/myrepo"
					},
					{
						"name": "myproject/myotherrepo"
					},
					{
						"name": "~USER/theirrepo"
					},
					{
						"pattern": "^topsecretproject/.*"
					}
				]
			],
			"items": {
				"additionalProperties": false,
				"anyOf": [
					{
						"required": [
							"name"
						]
					},
					{
						"required": [
							"id"
						]
					},
					{
						"required": [
							"pattern"
						]
					}
				],
				"properties": {
					"id": {
						"description": "The ID of a Bitbucket Server / Bitbucket Data Center repo (as returned by the Bitbucket Server / Bitbucket Data Center instance's API) to exclude from mirroring.",
						"type": "integer"
					},
					"name": {
						"description": "The name of a Bitbucket Server / Bitbucket Data Center repo (\"projectKey/repositorySlug\") to exclude from mirroring.",
						"pattern": "^~?[\\w-]+/[\\w.-]+$",
						"type": "string"
					},
					"pattern": {
						"description": "Regular expression which matches against the name of a Bitbucket Server / Bitbucket Data Center repo.",
						"format": "regex",
						"type": "string"
					}
				},
				"title": "ExcludedBitbucketServerRepo",
				"type": "object"
			},
			"minItems": 1,
			"type": "array"
		},
		"excludePersonalRepositories": {
			"default": false,
			"description": "Whether or not personal repositories should be excluded or not. When true, Sourcegraph will ignore personal repositories it may have access to. See https://sourcegraph.com/docs/integration/bitbucket_server#excluding-personal-repositories for more information.",
			"type": "boolean"
		},
		"gitSSHCipher": {
			"$ref": "git.schema.json#/definitions/gitSSHCipher",
			"description": "SSH cipher to use when cloning via SSH. Must be a valid choice from `ssh -Q cipher`."
		},
		"gitSSHCredential": {
			"$ref": "git.schema.json#/definitions/gitSSHCredential",
			"description": "SSH keys to use when cloning Git repo."
		},
		"gitURLType": {
			"default": "http",
			"description": "The type of Git URLs to use for cloning and fetching Git repositories on this Bitbucket Server / Bitbucket Data Center instance.\n\nIf \"http\", Sourcegraph will access Bitbucket Server / Bitbucket Data Center repositories using Git URLs of the form http(s)://bitbucket.example.com/scm/myproject/myrepo.git (using https: if the Bitbucket Server / Bitbucket Data Center instance uses HTTPS).\n\nIf \"ssh\", Sourcegraph will access Bitbucket Server / Bitbucket Data Center repositories using Git URLs of the form ssh://git@example.bitbucket.org/myproject/myrepo.git. See the documentation for how to provide SSH private keys and known_hosts: https://sourcegraph.com/docs/admin/repo/auth.",
			"enum": [
				"http",
				"ssh"
			],
			"examples": [
				"ssh"
			],
			"type": "string"
		},
		"initialRepositoryEnablement": {
			"default": false,
			"description": "Deprecated and ignored field which will be removed entirely in the next release. BitBucket repositories can no longer be enabled or disabled explicitly.",
			"type": "boolean"
		},
		"maxDeletions": {
			"default": 0,
			"description": "The maximum number of repos that will be deleted per sync. A value of 0 or less indicates no maximum.",
			"type": "integer"
		},
		"password": {
			"description": "The password to use when authenticating to the Bitbucket Server / Bitbucket Data Center instance. Also set the corresponding \"username\" field.\n\nFor Bitbucket Server / Bitbucket Data Center instances that support personal access tokens (Bitbucket Server / Bitbucket Data Center version 5.5 and newer), it is recommended to provide a token instead (in the \"token\" field).",
			"type": "string"
		},
		"plugin": {
			"description": "Configuration for Bitbucket Server / Bitbucket Data Center Sourcegraph plugin",
			"properties": {
				"permissions": {
					"default": "disabled",
					"description": "Enables fetching Bitbucket Server / Bitbucket Data Center permissions through the roaring bitmap endpoint. Warning: there may be performance degradation under significant load.",
					"enum": [
						"enabled",
						"disabled"
					],
					"type": "string"
				},
				"webhooks": {
					"deprecationMessage": "Deprecated in favour of first class webhooks. See https://sourcegraph.com/docs/admin/config/webhooks/incoming#deprecation-notice",
					"properties": {
						"disableSync": {
							"default": false,
							"description": "Disallow Sourcegraph from automatically syncing webhook config with the Bitbucket Server / Bitbucket Data Center instance. For details of how the webhook is configured, see our docs: https://sourcegraph.com/docs/admin/code_hosts/bitbucket_server#webhooks",
							"type": "boolean"
						},
						"secret": {
							"description": "Secret for authenticating incoming webhook payloads",
							"minLength": 1,
							"type": "string"
						}
					},
					"required": [
						"secret"
					],
					"title": "BitbucketServerPluginWebhooks",
					"type": "object"
				}
			},
			"title": "BitbucketServerPlugin",
			"type": "object"
		},
		"projectKeys": {
			"description": "An array of project key strings that defines a collection of repositories related to their associated project keys",
			"items": {
				"type": "string"
			},
			"type": "array"
		},
		"rateLimit": {
			"default": {
				"enabled": true,
				"requestsPerHour": 28800
			},
			"description": "Rate limit applied when making background API requests to BitbucketServer.",
			"properties": {
				"enabled": {
					"default": true,
					"description": "true if rate limiting is enabled.",
					"type": "boolean"
				},
				"requestsPerHour": {
					"default": 28800,
					"description": "Requests per hour permitted. This is an average, calculated per second. Internally, the burst limit is set to 500, which implies that for a requests per hour limit as low as 1, users will continue to be able to send a maximum of 500 requests immediately, provided that the complexity cost of each request is 1.",
					"minimum": 0,
					"type": "number"
				}
			},
			"required": [
				"enabled",
				"requestsPerHour"
			],
			"title": "BitbucketServerRateLimit",
			"type": "object"
		},
		"repos": {
			"description": "An array of repository \"projectKey/repositorySlug\" strings specifying repositories to mirror on Sourcegraph.",
			"examples": [
				[
					"myproject/myrepo",
					"myproject/myotherrepo",
					"~USER/theirrepo"
				]
			],
			"items": {
				"pattern": "^~?[\\w-]+/[\\w.-]+$",
				"type": "string"
			},
			"minItems": 1,
			"type": "array"
		},
		"repositoryPathPattern": {
			"default": "{host}/{projectKey}/{repositorySlug}",
			"description": "The pattern used to generate the corresponding Sourcegraph repository name for a Bitbucket Server / Bitbucket Data Center repository.\n\n - \"{host}\" is replaced with the Bitbucket Server / Bitbucket Data Center URL's host (such as bitbucket.example.com)\n - \"{projectKey}\" is replaced with the Bitbucket repository's parent project key (such as \"PRJ\")\n - \"{repositorySlug}\" is replaced with the Bitbucket repository's slug key (such as \"my-repo\").\n\nFor example, if your Bitbucket Server / Bitbucket Data Center is https://bitbucket.example.com and your Sourcegraph is https://src.example.com, then a repositoryPathPattern of \"{host}/{projectKey}/{repositorySlug}\" would mean that a Bitbucket Server / Bitbucket Data Center repository at https://bitbucket.example.com/projects/PRJ/repos/my-repo is available on Sourcegraph at https://src.example.com/bitbucket.example.com/PRJ/my-repo.\n\nIt is important that the Sourcegraph repository name generated with this pattern be unique to this code host. If different code hosts generate repository names that collide, Sourcegraph's behavior is undefined.",
			"examples": [
				"{projectKey}/{repositorySlug}"
			],
			"type": "string"
		},
		"repositoryQuery": {
			"default": [
				"none"
			],
			"description": "An array of strings specifying which repositories to mirror on Sourcegraph. Each string is a URL query string with parameters that filter the list of returned repos. Examples: \"?name=my-repo\u0026projectname=PROJECT\u0026visibility=private\".\n\nThe special string \"none\" can be used as the only element to disable this feature. Repositories matched by multiple query strings are only imported once. Here's the official Bitbucket Server / Bitbucket Data Center documentation about which query string parameters are valid: https://docs.atlassian.com/bitbucket-server/rest/6.1.2/bitbucket-rest.html#idp355",
			"examples": [
				[
					"?name=my-repo\u0026projectname=PROJECT\u0026visibility=private"
				]
			],
			"items": {
				"minLength": 1,
				"type": "string"
			},
			"minItems": 1,
			"type": "array"
		},
		"token": {
			"description": "A Bitbucket Server / Bitbucket Data Center personal access token with Read permissions. When using batch changes, the token needs Write permissions. Create one at https://[your-bitbucket-hostname]/plugins/servlet/access-tokens/add. Also set the corresponding \"username\" field.\n\nFor Bitbucket Server / Bitbucket Data Center instances that don't support personal access tokens (Bitbucket Server / Bitbucket Data Center version 5.4 and older), specify user-password credentials in the \"username\" and \"password\" fields.",
			"minLength": 1,
			"type": "string"
		},
		"url": {
			"!go": {
				"typeName": "NormalizedURL"
			},
			"description": "URL of a Bitbucket Server / Bitbucket Data Center instance, such as https://bitbucket.example.com.",
			"examples": [
				"https://bitbucket.example.com"
			],
			"format": "uri",
			"not": {
				"pattern": "example\\.com",
				"type": "string"
			},
			"pattern": "^https?://",
			"type": "string"
		},
		"username": {
			"description": "The username to use when authenticating to the Bitbucket Server / Bitbucket Data Center instance. Also set the corresponding \"token\" or \"password\" field.",
			"type": "string"
		},
		"webhooks": {
			"description": "DEPRECATED: Switch to \"plugin.webhooks\"",
			"properties": {
				"secret": {
					"description": "Secret for authenticating incoming webhook payloads",
					"minLength": 1,
					"type": "string"
				}
			},
			"type": "object"
		}
	},
	"required": [
		"username",
		"url"
	],
	"title": "BitbucketServerConnection",
	"type": "object"
}
```
{/* SCHEMA_SYNC_END: admin/code_hosts/bitbucket_server.schema.json */}
## Configuration Notes

Bitbucket Server/Data Center connections provide comprehensive configuration options for enterprise environments:

- **Repository Selection**: Use `repos` for specific repositories in `projectKey/repositorySlug` format, `repositoryQuery` for API-based filtering, and `exclude` for fine-grained exclusions
- **Project Keys**: The `projectKeys` field allows syncing all repositories from specific projects
- **Personal Repository Handling**: Use `excludePersonalRepositories` to filter out personal repositories that may be accessible
- **Path Patterns**: The `repositoryPathPattern` field supports variables like `{host}`, `{projectKey}`, and `{repositorySlug}` for flexible repository naming

### Authentication Methods

Bitbucket Server supports multiple authentication approaches:
- **Personal Access Tokens**: Recommended for v5.5+ with granular permissions
- **Username/Password**: Required for older versions (pre-5.5) that don't support PATs
- **OAuth1**: For permission syncing with application links
- **OAuth2**: Simplified permission syncing (requires auth provider configuration)

### Rate Limiting Configuration

Bitbucket Server connections include rate limiting for API management:
- Default: 28,800 requests per hour with rate limiting enabled
- Adjust based on your instance's capacity and usage patterns
- Monitor API usage to prevent hitting Bitbucket's internal limits

## Security Considerations

### Authentication Security

**Personal Access Tokens**: Provide fine-grained access control:
- Create tokens with minimal required permissions (read for syncing, write for Batch Changes)
- Use dedicated service accounts rather than personal tokens
- Regularly rotate tokens and audit their usage
- Tokens are preferred over username/password for better security

**OAuth Configuration**: Requires careful setup but provides enhanced security:
- OAuth1 requires RSA key pairs and proper application link configuration
- OAuth2 provides simpler setup with similar security benefits
- Both methods support user impersonation for proper permission syncing

### Permission Syncing Security

Bitbucket Server permission syncing has specific security requirements:
- **Username Matching**: Requires identical usernames between Sourcegraph and Bitbucket Server
- **External Authentication**: Use LDAP/Active Directory for consistent user management
- **Username Changes**: Disable username changes (`auth.enableUsernameChanges: false`) to prevent privilege escalation
- **Plugin Benefits**: The Sourcegraph plugin enables more efficient permission syncing and personal repository support

### SSL/TLS Configuration

For Bitbucket Server instances with custom certificates:
- Use the `certificate` field to specify custom CA certificates
- Obtain certificates using: `openssl s_client -connect HOST:443 -showcerts`
- Ensure certificate chain includes all intermediate certificates

### Application Link Security

When configuring OAuth1 application links:
- Generate strong consumer keys using cryptographic randomness
- Use RSA keys with at least 4096-bit length
- Store private keys securely and restrict access
- Enable 2-Legged OAuth with proper execute-as user configuration

## Common Examples

### Basic Repository Sync with Personal Access Token
```json
{
  "url": "https://bitbucket.company.com",
  "username": "sourcegraph-service",
  "token": "NjY4MDAzNDI2NTMx...",
  "repos": [
    "PROJECT/repository-name",
    "SHARED/common-library"
  ]
}
```

### Project-wide Sync with Exclusions
```json
{
  "url": "https://bitbucket.company.com",
  "username": "sourcegraph-service", 
  "token": "NjY4MDAzNDI2NTMx...",
  "projectKeys": ["ENGINEERING", "PLATFORM"],
  "exclude": [
    {"name": "ENGINEERING/deprecated-service"},
    {"pattern": "^.*-archive$"}
  ],
  "excludePersonalRepositories": true
}
```

### Advanced Query with OAuth2 Authorization
```json
{
  "url": "https://bitbucket.company.com",
  "username": "sourcegraph-service",
  "token": "NjY4MDAzNDI2NTMx...",
  "repositoryQuery": [
    "?name=microservice&projectname=PLATFORM",
    "?visibility=public"
  ],
  "authorization": {
    "oauth2": true
  }
}
```

### SSH Configuration with Custom Path Pattern
```json
{
  "url": "https://bitbucket.company.com",
  "username": "sourcegraph-service",
  "token": "NjY4MDAzNDI2NTMx...",
  "repositoryQuery": ["?projectname=MOBILE"],
  "gitURLType": "ssh",
  "repositoryPathPattern": "bitbucket/{projectKey}/{repositorySlug}",
  "certificate": "-----BEGIN CERTIFICATE-----\n..."
}
```

### Plugin-enabled Fast Permission Sync
```json
{
  "url": "https://bitbucket.company.com", 
  "username": "sourcegraph-service",
  "token": "NjY4MDAzNDI2NTMx...",
  "repositoryQuery": ["all"],
  "authorization": {
    "oauth2": true
  },
  "plugin": {
    "permissions": "enabled"
  },
  "rateLimit": {
    "enabled": true,
    "requestsPerHour": 20000
  }
}
```

## Best Practices

### Authentication Management

1. **Use Personal Access Tokens** whenever possible instead of username/password authentication
2. **Create dedicated service accounts** for Sourcegraph rather than using personal accounts
3. **Implement token rotation** policies to regularly refresh access tokens
4. **Configure OAuth2** for permission syncing when user authentication is required

### Repository Organization

1. **Use project-based organization** with `projectKeys` for better management at scale
2. **Implement exclusion patterns** to filter out archived, personal, or test repositories
3. **Use consistent path patterns** that reflect your organizational structure
4. **Exclude personal repositories** unless specifically required for your use case

### Performance Optimization

1. **Install the Sourcegraph plugin** for faster permission syncing and enhanced features
2. **Configure appropriate rate limits** based on your Bitbucket Server instance's capacity
3. **Use specific repository queries** rather than broad "all" queries when possible
4. **Monitor API usage** to avoid overloading your Bitbucket Server instance

### Permission Management

1. **Ensure username consistency** between Sourcegraph and Bitbucket Server through external auth
2. **Disable username changes** in Sourcegraph site configuration to prevent privilege escalation
3. **Test permission syncing** thoroughly before deploying to production
4. **Use the Sourcegraph plugin** for more efficient permission syncing

### Maintenance

1. **Monitor connection health** through the site admin interface
2. **Keep certificates updated** for Bitbucket Server instances with custom SSL
3. **Review repository queries** periodically as your project structure evolves
4. **Update the Sourcegraph plugin** when new versions become available
